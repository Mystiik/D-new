<?php
//----------------------------------------------------------------------------------------------------------------
// Initialisation
//----------------------------------------------------------------------------------------------------------------
include_once('include/init.php');

//----------------------------------------------------------------------------------------------------------------
// Find available connection file
//----------------------------------------------------------------------------------------------------------------
for ($i = 0; $i < 1000; $i++) {
  $path = Server::$communicationPath . '/stream_' . rand(0, Server::$communicationNumber) . '.txt';
  if (filesize($path) == 0) {
    $file = fopen($path, 'r+');
    if (flock($file, LOCK_EX | LOCK_NB)) {
      break;
    }
    unset($file);
  }
}

if (!isset($file)) {
  echo "ERROR, Server is at max capacity!";
  die();
}

//----------------------------------------------------------------------------------------------------------------
// Send request
//----------------------------------------------------------------------------------------------------------------
$message = "Coucou, je suis le client !!" . rand();
fwrite($file, 'REQUEST|' . $message);
// fflush($file); // ??
flock($file, LOCK_UN);

//----------------------------------------------------------------------------------------------------------------
// Read response
//----------------------------------------------------------------------------------------------------------------
while (@fread($file, 9) != 'RESPONSE|') {
  rewind($file);
  usleep(2000);
}

clearstatcache(); // refresh filesize info
echo fread($file, filesize($path));

//----------------------------------------------------------------------------------------------------------------
// Cleaning & Closing file
//----------------------------------------------------------------------------------------------------------------
ftruncate($file, 0);
fclose($file);